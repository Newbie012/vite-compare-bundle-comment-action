# vite-compare-bundle-comment-action

Compare two Vite analyzer `stats.json` files and post a single updatable pull request comment with bundle size changes.

This action is built to avoid false positives when multiple chunk files share the same stem (for example, multiple `index-*.js` files).

## What it does

- Reads base and head Vite stats JSON files
- Compares total parsed and gzip sizes
- Matches chunks in a collision-safe way for hashed filenames
- Creates or updates one PR comment (deduplicated by a hidden marker)

## Inputs

| Name                      | Required | Default                       | Description                                       |
| ------------------------- | -------- | ----------------------------- | ------------------------------------------------- |
| `github-token`            | yes      | -                             | GitHub token used to create/update the PR comment |
| `base-stats-json-path`    | yes      | -                             | Path to base branch stats JSON                    |
| `current-stats-json-path` | yes      | -                             | Path to head/current branch stats JSON            |
| `title`                   | no       | `Vite Bundle Size Comparison` | Comment title and marker key                      |
| `output-path`             | no       | `./bundle-size-comment.md`    | Local path for generated markdown                 |

## One-step usage

```yaml
- name: Compare bundle size
  uses: Newbie012/vite-compare-bundle-comment-action@v1
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    base-stats-json-path: ./stats/base/stats.json
    current-stats-json-path: ./stats/head/stats.json
    title: Web App Bundle Size Comparison
```

## Full Nx + Vite example

```yaml
name: Compare bundle size

on:
  pull_request:
    branches: [main]

jobs:
  build-head:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - run: npm ci
      - run: npx nx build web
        env:
          ANALYZE: true

      - uses: actions/upload-artifact@v4
        with:
          name: head-stats
          path: apps/web/dist/stats.json

  build-base:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - run: npm ci
      - run: npx nx build web
        env:
          ANALYZE: true

      - uses: actions/upload-artifact@v4
        with:
          name: base-stats
          path: apps/web/dist/stats.json

  compare:
    runs-on: ubuntu-latest
    needs: [build-base, build-head]
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - uses: actions/download-artifact@v4
        with:
          path: ./stats

      - uses: Newbie012/vite-compare-bundle-comment-action@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          base-stats-json-path: ./stats/base-stats/stats.json
          current-stats-json-path: ./stats/head-stats/stats.json
          title: Web App Bundle Size Comparison
```

## Stats format

The action expects JSON arrays generated by a Vite bundle analyzer plugin with entries that include:

- `filename` or `label`
- `parsedSize`
- `gzipSize`

## Local smoke test

```bash
node scripts/compare-bundle-size.mjs \
  --base fixtures/base-stats.json \
  --current fixtures/current-stats.json \
  --title "Fixture Comparison" \
  --output /tmp/bundle-comment.md
```

## License

MIT

## Acknowledgments

This action was inspired by [`wojtekmaj/vite-compare-bundle-size`](https://github.com/wojtekmaj/vite-compare-bundle-size).
It was implemented independently with a different asset matching strategy
to handle hashed filename collisions (for example, multiple `index-*.js` chunks).

## Development Note

If you are validating CI behavior, open a temporary pull request from a feature branch to trigger the smoke-test workflow.
